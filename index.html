<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>In-Office Presence Tracker (Public Access)</title>

<style>
  body { font-family: "Segoe UI", sans-serif; background:#f7faff; color:#222; margin:0; padding:20px; }
  h1 { text-align:center; color:#0057b7; }
  #controls { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0; }
  #controls label,#controls input,#controls button {
    flex:1 1 150px; min-width:120px; padding:6px; border-radius:6px; border:1px solid #ccc; font-size:1em;
  }
  #controls button { background:#0057b7; color:white; cursor:pointer; border:none; border-radius:6px; }
  #summary { background:#fff; border-left:6px solid #0057b7; padding:20px; margin:20px auto; width:95%;
             border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  .table-container { overflow-x:auto; width:100%; }
  table { width:100%; border-collapse:collapse; margin-top:20px; min-width:900px; }
  th,td { border:1px solid #ddd; text-align:center; padding:10px; }
  th { background:#0057b7; color:white; }
  tr:nth-child(even){background:#f2f8ff;}
  .high { color:#008000; font-weight:bold; }
  .medium { color:#e6b800; font-weight:bold; }
  .low { color:#d9534f; font-weight:bold; }
  @media(max-width:600px){body{font-size:14px;}table th,td{padding:6px;font-size:13px;}#summary{font-size:14px;}}
</style>
</head>
<body>

<h1>üè¢ In-Office Presence Tracker</h1>

<!-- Controls -->
<div id="controls">
  <label for="deadline">Deadline:</label>
  <input type="date" id="deadline" value="2025-12-26">
  <label for="target">Target %:</label>
  <input type="number" id="target" value="30" min="1" max="100" step="0.1">
  <button id="generateBtn">Generate</button>
</div>

<!-- Summary -->
<div id="summary">
  <h2>üìä Summary (Live)</h2>
  <p>Current Office Days: <span id="summaryDays">0</span></p>
  <p>Current Presence: <span id="summaryPercent">0%</span></p>
  <p>Target Presence: <span id="targetPercent">30%</span></p>
  <p>Required Office Days: <span id="requiredDays">0</span></p>
  <p>Suggested Days/Week: <span id="suggestedDaysWeek">0</span></p>
</div>

<!-- Table -->
<div class="table-container">
  <table id="presenceTable">
    <thead>
      <tr>
        <th>Week Start</th>
        <th>Week End</th>
        <th>Office Days</th>
        <th>Working Days</th>
        <th>Leave/Holiday Days</th>
        <th>Weekly %</th>
        <th>Cumulative Office Days</th>
        <th>Cumulative %</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- ‚úÖ Load Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  window.supabase = window.Supabase.createClient("https://...supabase.co", "YOUR_ANON_KEY");
</script>

<script>
window.addEventListener("load", () => {
  if (!window.Supabase) { alert("‚ùå Supabase failed to load"); return; }

  // ‚úÖ Your Supabase project details
  const SUPABASE_URL = "https://febpaanqrqgrnbyrvfxx.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ";

  const supabase = window.Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  console.log("‚úÖ Supabase client ready (public)", supabase);

  const tableBody = document.getElementById("tableBody");
  const totalDays = 260;
  let cumulativeOfficeDays = 56.68;
  const today = new Date("2025-10-20");

  // ----------- Generate Table ------------
  async function generateTable() {
    tableBody.innerHTML = "";
    const deadline = new Date(document.getElementById("deadline").value);

    // üì• Fetch all data
    const { data: dbData, error } = await supabase
      .from("office_presence")
      .select("*")
      .order("week_start");
    if (error) { alert("Database fetch error: " + error.message); return; }

    // Add saved rows
    dbData?.forEach(row =>
      addRow(new Date(row.week_start), new Date(row.week_end),
        row.office_days, row.working_days, 0, true)
    );

    // Add upcoming rows
    let start = new Date(today);
    while (start <= deadline) {
      const end = new Date(start);
      end.setDate(start.getDate() + 4);
      addRow(start, end);
      start.setDate(start.getDate() + 7);
    }
    recalculate();
  }

  // ----------- Add Row ------------
  function addRow(weekStart, weekEnd, officeDays = "", workDays = "", leaveDays = "", isSaved = false) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${formatDate(weekStart)}</td>
      <td>${formatDate(weekEnd)}</td>
      <td><input type="number" step="0.1" value="${officeDays}"></td>
      <td><input type="number" step="0.1" value="${workDays}"></td>
      <td><input type="number" step="0.1" value="${leaveDays}"></td>
      <td class="weekly"></td>
      <td class="cumulativeDays"></td>
      <td class="cumulativePercent"></td>
      <td><button>${isSaved ? "Update" : "Add"}</button></td>
    `;
    tableBody.appendChild(row);

    // Save / Update button
    row.querySelector("button").addEventListener("click", async () => {
      const weekStartStr = row.cells[0].textContent;
      const weekEndStr = row.cells[1].textContent;
      const officeDaysVal = parseFloat(row.cells[2].querySelector("input").value) || 0;
      const workingDaysVal = parseFloat(row.cells[3].querySelector("input").value) || 0;

      const { error } = await supabase.from("office_presence").upsert([
        {
          week_start: weekStartStr,
          week_end: weekEndStr,
          office_days: officeDaysVal,
          working_days: workingDaysVal
        }
      ]);
      if (error) return alert("‚ùå Save error: " + error.message);
      row.querySelector("button").textContent = "Update";
      recalcRow(row);
    });

    row.querySelectorAll("input").forEach(inp =>
      inp.addEventListener("input", () => recalcRow(row))
    );
    recalcRow(row);
  }

  // ----------- Recalculate Rows ------------
  function recalcRow(row) {
    const office = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const work = parseFloat(row.cells[3].querySelector("input").value) || 0;
    const weeklyCell = row.cells[5];
    const weekly = work ? (office / work) * 100 : 0;
    weeklyCell.className = weekly >= 60 ? "high" : weekly >= 20 ? "medium" : "low";
    weeklyCell.textContent = weekly ? weekly.toFixed(1) + "%" : "";
    recalculate();
  }

  function recalculate() {
    const rows = document.querySelectorAll("#presenceTable tbody tr");
    let cumulative = 56.68;
    rows.forEach((row, i) => {
      const office = parseFloat(row.cells[2].querySelector("input").value) || 0;
      if (i > 0) cumulative += office;
      row.cells[6].textContent = cumulative.toFixed(2);
      row.cells[7].textContent = ((cumulative / totalDays) * 100).toFixed(2) + "%";
    });
    updateSummary(cumulative);
  }

  function updateSummary(cumulative) {
    const deadline = new Date(document.getElementById("deadline").value);
    const targetPercent = parseFloat(document.getElementById("target").value);
    const currentPercent = (cumulative / totalDays) * 100;
    const targetDays = (targetPercent / 100) * totalDays;
    const needed = Math.max(0, targetDays - cumulative);
    const diffWeeks = Math.ceil((deadline - today) / (7 * 24 * 60 * 60 * 1000));
    const daysPerWeek = needed / diffWeeks;

    document.getElementById("summaryDays").textContent = cumulative.toFixed(2);
    document.getElementById("summaryPercent").textContent = currentPercent.toFixed(2) + "%";
    document.getElementById("requiredDays").textContent = needed.toFixed(1);
    document.getElementById("suggestedDaysWeek").textContent = daysPerWeek.toFixed(2);
  }

  function formatDate(d) {
    return d.toISOString().split("T")[0];
  }

  document.getElementById("generateBtn").addEventListener("click", generateTable);

  // Auto-load data on page open
  generateTable();
});
</script>
</body>
</html>
