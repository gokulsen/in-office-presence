<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>In-Office Presence Dashboard</title>

<style>
:root {
  --primary: #0077cc;
  --accent: #4dabf7;
  --bg: #f8fbff;
  --card: #ffffff;
  --text: #1c1c1c;
}
body {
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
h1 {
  color: var(--primary);
  margin-top: 10px;
  font-size: 2rem;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 5px;
  text-align: center;
  width: fit-content;
}

/* Controls */
#controls {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.06);
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  padding: 14px;
  width: 95%;
  max-width: 900px;
  margin-top: 20px;
}
#controls label {
  font-weight: 600;
  align-self: center;
}
#controls input, #controls button {
  border: 1px solid #d0d7de;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 1rem;
}
#controls button {
  background: var(--primary);
  color: white;
  cursor: pointer;
  transition: background 0.3s;
}
#controls button:hover { background: var(--accent); }

/* Overview */
#overview {
  background: linear-gradient(145deg,#f0f7ff,#fff);
  border-radius: 16px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  padding: 20px 25px;
  width: 95%;
  max-width: 900px;
  margin: 25px 0 15px 0;
}
#overview h2 {
  color: var(--primary);
  margin: 0 0 10px;
}
#overview p {
  font-size: 1rem;
  margin: 6px 0;
}
#overview span {
  font-weight: 600;
  color: var(--primary);
}

/* Table */
.table-container {
  overflow-x: auto;
  width: 95%;
  max-width: 950px;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 920px;
}
th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #e6ebf0;
}
th {
  background: var(--primary);
  color: #fff;
  font-weight: 500;
  position: sticky;
  top: 0;
}
tr:nth-child(even) { background: #f9fbfd; }
input[type="number"] {
  width: 70px;
  border-radius: 6px;
  padding: 4px;
  text-align: center;
}
button.table-btn {
  padding: 5px 10px;
  border-radius: 6px;
  border: none;
  background: var(--primary);
  color: white;
  cursor: pointer;
}
button.table-btn:hover { background: var(--accent); }

.high { color: #1a7f37; font-weight: bold; }
.medium { color: #d79c00; font-weight: bold; }
.low { color: #c92a2a; font-weight: bold; }

footer {
  margin-top: 25px;
  font-size: 0.85rem;
  color: #777;
}

@media(max-width:600px){
  h1 { font-size: 1.6rem; }
  th,td { font-size: 0.85rem; }
}
</style>
</head>
<body>

<h1>In-Office Presence Dashboard</h1>

<div id="controls">
  <label for="deadline">Deadline:</label>
  <input type="date" id="deadline" value="2025-12-26">
  <label for="target">Target %:</label>
  <input type="number" id="target" value="30" min="1" max="100" step="0.1">
  <button id="generateBtn">Generate</button>
</div>

<div id="overview">
  <h2>Overview</h2>
  <p>In-Office Days So Far: <span id="summaryDays">0</span></p>
  <p>Current Presence Rate: <span id="summaryPercent">0%</span></p>
  <p>Goal Presence Target: <span id="targetPercent">30%</span></p>
  <p>Additional Office Days Needed: <span id="requiredDays">0</span></p>
  <p>Suggested Office Days per Week: <span id="suggestedDaysWeek">0</span></p>
</div>

<div class="table-container">
<table id="presenceTable">
  <thead>
    <tr>
      <th>Week Start</th>
      <th>Week End</th>
      <th>Office Days</th>
      <th>Working Days</th>
      <th>Leave Days</th>
      <th>Weekly %</th>
      <th>Cumulative Days</th>
      <th>Cumulative %</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>
</div>

<footer>Auto-synced with Supabase | Last updated: <span id="lastUpdated"></span></footer>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://febpaanqrqgrnbyrvfxx.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const totalDays = 260;
const DEFAULT_WEEKDAYS = 5;
const today = new Date();
let startingCumulative = 56.68;

const tableBody = document.getElementById("tableBody");
const lastUpdated = document.getElementById("lastUpdated");

function fmt(d){return new Date(d).toISOString().slice(0,10);}

function addRow(weekStart, weekEnd, office="", working="", leave="", saved=false){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${fmt(weekStart)}</td>
    <td>${fmt(weekEnd)}</td>
    <td><input type="number" step="0.1" value="${office}"></td>
    <td><input type="number" step="0.1" value="${working}"></td>
    <td><input type="number" step="0.1" value="${leave}"></td>
    <td class="weekly"></td>
    <td class="cumulativeDays"></td>
    <td class="cumulativePercent"></td>
    <td><button class="table-btn">${saved?"Update":"Add"}</button></td>`;
  tableBody.appendChild(tr);

  const officeInput=tr.cells[2].querySelector("input");
  const workInput=tr.cells[3].querySelector("input");
  const leaveInput=tr.cells[4].querySelector("input");
  const actionBtn=tr.cells[8].querySelector("button");

  leaveInput.addEventListener("input",()=>{if(!workInput.value){workInput.value=DEFAULT_WEEKDAYS-(parseFloat(leaveInput.value)||0);}recalcRow(tr);});
  [officeInput,workInput].forEach(i=>i.addEventListener("input",()=>recalcRow(tr)));

  actionBtn.addEventListener("click",async()=>{
    const ws=tr.cells[0].textContent;
    const we=tr.cells[1].textContent;
    const o=parseFloat(officeInput.value)||0;
    const w=parseFloat(workInput.value)||Math.max(0,DEFAULT_WEEKDAYS-(parseFloat(leaveInput.value)||0));
    await supabase.from("office_presence").upsert({week_start:ws,week_end:we,office_days:o,working_days:w},{onConflict:['week_start']});
    actionBtn.textContent="Update";
    recalcRow(tr);
    lastUpdated.textContent=new Date().toLocaleString();
  });

  recalcRow(tr);
}

function recalcRow(tr){
  const o=parseFloat(tr.cells[2].querySelector("input").value)||0;
  const w=parseFloat(tr.cells[3].querySelector("input").value)||Math.max(0,DEFAULT_WEEKDAYS-(parseFloat(tr.cells[4].querySelector("input").value)||0));
  const weekly=w?(o/w)*100:0;
  tr.cells[5].className=weekly>=60?"high":weekly>=20?"medium":"low";
  tr.cells[5].textContent=weekly?weekly.toFixed(1)+"%":"";
  recalcAll();
}

function recalcAll(){
  const rows=[...document.querySelectorAll("#presenceTable tbody tr")];
  let cumulative=startingCumulative;
  rows.forEach((r,i)=>{
    const o=parseFloat(r.cells[2].querySelector("input").value)||0;
    if(i>0)cumulative+=o;
    r.cells[6].textContent=cumulative.toFixed(2);
    r.cells[7].textContent=((cumulative/totalDays)*100).toFixed(2)+"%";
  });
  updateOverview(cumulative);
}

function updateOverview(cumulative){
  const deadline=new Date(document.getElementById("deadline").value);
  const target=parseFloat(document.getElementById("target").value);
  const currPct=(cumulative/totalDays)*100;
  const targetDays=(target/100)*totalDays;
  const needed=Math.max(0,targetDays-cumulative);
  const weeksLeft=Math.ceil((deadline-today)/(7*24*60*60*1000));
  const perWeek=weeksLeft>0?needed/weeksLeft:0;

  document.getElementById("summaryDays").textContent=cumulative.toFixed(2);
  document.getElementById("summaryPercent").textContent=currPct.toFixed(2)+"%";
  document.getElementById("targetPercent").textContent=target+"%";
  document.getElementById("requiredDays").textContent=needed.toFixed(1);
  document.getElementById("suggestedDaysWeek").textContent=perWeek.toFixed(2);
}

async function generateTable(){
  tableBody.innerHTML="";
  const deadline=new Date(document.getElementById("deadline").value);
  const {data}=await supabase.from("office_presence").select("*").order("week_start");
  if(data){data.forEach(r=>addRow(new Date(r.week_start),new Date(r.week_end),r.office_days,r.working_days,0,true));}
  let lastEnd=data?.length?new Date(data[data.length-1].week_end):new Date(today);
  let start=new Date(lastEnd); start.setDate(start.getDate()+3);
  while(start<=deadline){
    const end=new Date(start); end.setDate(start.getDate()+4);
    addRow(start,end); start.setDate(start.getDate()+7);
  }
  recalcAll();
}

document.getElementById("generateBtn").addEventListener("click",generateTable);
generateTable();
lastUpdated.textContent=new Date().toLocaleString();
</script>
</body>
</html>