<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>In-Office Presence Tracker</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f7faff; color: #222; padding: 20px; }
  h1 { text-align: center; color: #0057b7; }
  #controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
  input, button { padding: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
  button { background: #0057b7; color: white; cursor: pointer; }
  #summary { background: #fff; border-left: 6px solid #0057b7; padding: 20px; margin: 20px auto; width: 90%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; text-align: center; padding: 10px; }
  th { background: #0057b7; color: white; }
  tr:nth-child(even) { background: #f2f8ff; }
  .high { color: #008000; font-weight: bold; }
  .medium { color: #e6b800; font-weight: bold; }
  .low { color: #d9534f; font-weight: bold; }
</style>
</head>
<body>
<h1>In-Office Presence Tracker</h1>

<div id="controls">
  <label for="deadline">Choose Deadline:</label>
  <input type="date" id="deadline" value="2025-12-26">
  <label for="target">Target %:</label>
  <input type="number" id="target" value="30" min="1" max="100" step="0.1">
  <button onclick="generateTable()">Generate</button>
</div>

<div id="summary">
  <h2>ðŸ“Š Summary (Live)</h2>
  <p>Current In-Office Days: <span id="summaryDays">0</span></p>
  <p>Current In-Office Presence: <span id="summaryPercent">0%</span></p>
  <p>Target Presence: <span id="targetPercent">30%</span></p>
  <p>Required Office Days (to reach target): <span id="requiredDays">0</span></p>
  <p>Suggested Days/Week (until deadline): <span id="suggestedDaysWeek">0</span></p>
</div>

<table id="presenceTable">
  <thead>
    <tr>
      <th>Week Start</th>
      <th>Week End</th>
      <th>Office Days</th>
      <th>Working Days</th>
      <th>Leave/Holiday Days</th>
      <th>Weekly Presence %</th>
      <th>Cumulative Office Days</th>
      <th>Cumulative Presence %</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ===== Supabase Configuration =====
const SUPABASE_URL = "https://febpaanqrqgrnbyrvfxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnBhYW5xcnFncm5ieXJ2Znh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDUzNzMsImV4cCI6MjA3NjUyMTM3M30.dFyrWiNKqGCVDGLN9HU2IyRuI6rqAJaZGwRQjXri3mQ";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const tableBody = document.getElementById("tableBody");
const totalDays = 260; // Total working days in 2025
let cumulativeOfficeDays = 56.68; // Starting cumulative value
const today = new Date("2025-10-20"); // Replace with new Date() for live use

function formatDate(date) { return date.toISOString().split("T")[0]; }

// ===== Generate Table =====
async function generateTable() {
  tableBody.innerHTML = "";
  const deadline = new Date(document.getElementById("deadline").value);

  // Load existing data from Supabase
  const { data: dbData, error } = await supabase
    .from("office_presence")
    .select("*")
    .order("week_start");

  if (error) return console.error(error);

  dbData.forEach(row => addRow(new Date(row.week_start), new Date(row.week_end), row.office_days, row.working_days, 0, true));

  // Add future weeks till deadline
  let start = new Date(today);
  while (start <= deadline) {
    const end = new Date(start);
    end.setDate(start.getDate() + 4);
    addRow(start, end); 
    start.setDate(start.getDate() + 7);
  }

  recalculate();
}

// ===== Add Row =====
function addRow(weekStart, weekEnd, officeDays = "", workDays = "", leaveDays = "", isSaved = false) {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${formatDate(weekStart)}</td>
    <td>${formatDate(weekEnd)}</td>
    <td><input type="number" step="0.1" value="${officeDays}"></td>
    <td><input type="number" step="0.1" value="${workDays}"></td>
    <td><input type="number" step="0.1" value="${leaveDays}"></td>
    <td class="weekly"></td>
    <td class="cumulativeDays"></td>
    <td class="cumulativePercent"></td>
    <td><button>${isSaved ? "Update" : "Add"}</button></td>
  `;
  tableBody.appendChild(row);

  const officeInput = row.cells[2].querySelector("input");
  const workInput = row.cells[3].querySelector("input");

  // Auto recalc on input change
  officeInput.addEventListener("input", () => recalcRow(row));
  workInput.addEventListener("input", () => recalcRow(row));

  // Add/Update button
  row.cells[8].querySelector("button").addEventListener("click", async () => {
    const weekStart = row.cells[0].textContent;
    const weekEnd = row.cells[1].textContent;
    const officeDaysVal = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const workingDaysVal = parseFloat(row.cells[3].querySelector("input").value) || 0;

    const { data, error } = await supabase
      .from("office_presence")
      .upsert([
        { week_start: weekStart, week_end: weekEnd, office_days: officeDaysVal, working_days: workingDaysVal }
      ], { onConflict: ['week_start'] });

    if (error) return alert("Error saving row: " + error.message);

    row.cells[8].querySelector("button").textContent = "Update";
    recalcRow(row);
  });

  recalcRow(row);
}

// ===== Recalculate Weekly & Cumulative =====
function recalcRow(row) {
  const office = parseFloat(row.cells[2].querySelector("input").value) || 0;
  const work = parseFloat(row.cells[3].querySelector("input").value) || 0;
  const weeklyCell = row.cells[5];

  const weekly = work ? (office / work) * 100 : 0;

  if (weekly >= 60) weeklyCell.className = "high";
  else if (weekly >= 20) weeklyCell.className = "medium";
  else weeklyCell.className = "low";

  weeklyCell.textContent = weekly ? weekly.toFixed(1) + "%" : "";

  // Update cumulative for all rows
  recalculate();
}

function recalculate() {
  const rows = document.querySelectorAll("#presenceTable tbody tr");
  let cumulative = 56.68;

  rows.forEach((row, i) => {
    const office = parseFloat(row.cells[2].querySelector("input").value) || 0;
    const weeklyCell = row.cells[5];
    const cumDaysCell = row.cells[6];
    const cumPercentCell = row.cells[7];

    if (i > 0) cumulative += office;
    cumDaysCell.textContent = cumulative.toFixed(2);
    cumPercentCell.textContent = ((cumulative / totalDays) * 100).toFixed(2) + "%";
  });

  updateSummary(cumulative);
}

// ===== Update Summary =====
function updateSummary(cumulative) {
  const deadline = new Date(document.getElementById("deadline").value);
  const targetPercent = parseFloat(document.getElementById("target").value);

  const summaryDays = document.getElementById("summaryDays");
  const summaryPercent = document.getElementById("summaryPercent");
  const requiredDays = document.getElementById("requiredDays");
  const suggestedDaysWeek = document.getElementById("suggestedDaysWeek");

  const currentPercent = (cumulative / totalDays) * 100;
  const targetDays = (targetPercent / 100) * totalDays;
  const needed = Math.max(0, targetDays - cumulative);

  const diffWeeks = Math.ceil((deadline - today) / (7 * 24 * 60 * 60 * 1000));
  const daysPerWeek = needed / diffWeeks;

  summaryDays.textContent = cumulative.toFixed(2);
  summaryPercent.textContent = currentPercent.toFixed(2) + "%";
  requiredDays.textContent = needed.toFixed(1);
  suggestedDaysWeek.textContent = daysPerWeek.toFixed(2);
}

// ===== Initialize =====
generateTable();
</script>
</body>
</html>
